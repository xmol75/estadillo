<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estadillo de Guardia - Cirugía</title>

  <!-- Bootstrap CSS + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

  <style>
    :root {
      --card-pad: 1.25rem;
    }
    body { background: #f8f9fa; }
    #app-container { display: none; }

    /* Password control styled to match the screenshot you provided:
       - small white rounded box inside the input on the right
       - fixed size / padding so it never pushes the input
    */
    .password-container { position: relative; }
    .password-container .form-control { padding-right: 56px; /* reserve space for the eye box */ }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      align-items: center;
      justify-content: center;

      background: #fff;
      border: 1px solid #d6dbe0; /* soft border like your screenshot */
      border-radius: 8px;
      padding: 6px 8px;
      height: 36px;
      line-height: 1;
      cursor: pointer;

      /* Prevent button from shifting layout when icon changes */
      min-width: 36px;
      box-sizing: border-box;
    }
    .password-toggle:focus {
      box-shadow: 0 0 0 3px rgba(13,110,253,0.12);
      border-color: #8ab1ff;
      outline: none;
    }
    .password-toggle i {
      font-size: 1.1rem;
      color: #495057;
      display: block;
      line-height: 1;
    }

    .form-section, .table-section { background: #fff; padding: var(--card-pad); border-radius: .75rem; box-shadow: 0 4px 18px rgba(0,0,0,.06); }
    .summary-card { background: #eef2f6; border-radius: .75rem; padding: var(--card-pad); }
    .summary-chip { font-weight: 600; }

    .inline-select { min-width: 120px; font-weight: 500; }
    .table-actions .btn { margin-right: 6px; }

    .patient-pending { background-color: #fff3cd !important; }
    .filter-tabs .nav-link { font-weight: 600; }

    /* Vista impresión (para exportar a PDF con Ctrl/Cmd+P) */
    @media print {
      #auth-container, #controls-bar, #add-patient-btn, .table-actions, #logout-btn, #change-guard-btn, #export-pdf-btn { display: none !important; }
      body { background: #fff; }
      .table-section, .summary-card { box-shadow: none; border: 0; }
    }

    /* Small adjustment for very narrow screens to avoid overlap */
    @media (max-width: 360px) {
      .password-container .form-control { padding-right: 48px; }
      .password-toggle { right: 8px; padding: 6px; height: 32px; border-radius: 6px; }
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <!-- AUTH -->
    <div id="auth-container">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="text-center mb-4">
            <h2>Estadillo de Guardia de Cirugía</h2>
            <p class="text-muted mb-0">Hospital Universitari Son Espases</p>
          </div>

          <!-- Login -->
          <div id="login-view">
            <div class="form-section">
              <h3 class="mb-4">Iniciar Sesión</h3>
              <form id="login-form" novalidate>
                <div class="mb-3">
                  <label for="login-email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="login-email" required />
                </div>
                <div class="mb-3 password-container">
                  <label for="login-password" class="form-label">Contraseña</label>
                  <input type="password" class="form-control" id="login-password" required />
                  <button type="button" class="password-toggle" id="toggle-login-password" title="Mostrar/ocultar">
                    <i class="bi bi-eye-slash" aria-hidden="true"></i>
                  </button>
                </div>
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
                <div id="login-error" class="text-danger mt-2"></div>
              </form>
              <p class="mt-3 text-center">¿No tienes cuenta? <a href="#" id="show-register">Regístrate aquí</a></p>
            </div>
          </div>

          <!-- Registro -->
          <div id="register-view" style="display:none;">
            <div class="form-section">
              <h3 class="mb-4">Registro</h3>
              <form id="register-form" novalidate>
                <div class="mb-3">
                  <label for="register-email" class="form-label">Email corporativo (@ssib.es)</label>
                  <input type="email" class="form-control" id="register-email" required />
                </div>
                <div class="mb-3 password-container">
                  <label for="register-password" class="form-label">Contraseña</label>
                  <input type="password" class="form-control" id="register-password" required />
                  <button type="button" class="password-toggle" id="toggle-register-password" title="Mostrar/ocultar">
                    <i class="bi bi-eye-slash" aria-hidden="true"></i>
                  </button>
                </div>
                <div id="password-rules" class="form-text mb-3">
                  <ul class="mb-0">
                    <li>Al menos 8 caracteres</li>
                    <li>Una mayúscula</li>
                    <li>Un número</li>
                    <li>Un símbolo especial</li>
                  </ul>
                </div>
                <button type="submit" class="btn btn-success w-100">Registrarse</button>
                <div id="register-error" class="text-danger mt-2"></div>
              </form>
              <p class="mt-3 text-center">¿Ya tienes cuenta? <a href="#" id="show-login">Inicia sesión</a></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="app-container">
      <header class="py-2">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div>
            <h1 class="h4 mb-1">Estadillo - CGD</h1>
            <small id="guardia-date" class="text-muted"></small>
          </div>
          <div class="d-flex gap-2">
            <button id="export-pdf-btn" class="btn btn-outline-secondary" title="Imprimir / Exportar PDF"><i class="bi bi-printer"></i> PDF</button>
            <button id="change-guard-btn" class="btn btn-warning"><i class="bi bi-arrow-repeat"></i> Finalizar y cambiar</button>
            <button id="logout-btn" class="btn btn-danger"><i class="bi bi-box-arrow-right"></i> Cerrar sesión</button>
          </div>
        </div>
      </header>

      <div id="controls-bar" class="row g-2 align-items-end my-2">
        <div class="col-md-6">
          <label class="form-label mb-1">Filtros rápidos</label>
          <ul class="nav nav-pills filter-tabs">
            <li class="nav-item"><button class="nav-link active" data-filter="todos">Todos</button></li>
            <li class="nav-item"><button class="nav-link" data-filter="pendientes">Pendientes</button></li>
            <li class="nav-item"><button class="nav-link" data-filter="resueltos">Resueltos</button></li>
          </ul>
        </div>
        <div class="col-md-6 text-md-end">
          <button id="add-patient-btn" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Añadir paciente</button>
        </div>
      </div>

      <!-- Tabla -->
      <section class="table-section">
        <div class="table-responsive">
          <table id="patient-table" class="table table-striped table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Localización</th>
                <th>Sitio</th>
                <th>Nombre y Apellidos</th>
                <th>Diagnóstico</th>
                <th>Tratamiento</th>
                <th>Comentario</th>
                <th>Estado</th>
                <th class="text-nowrap">Acciones</th>
              </tr>
            </thead>
            <tbody id="patient-table-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Resumen: reordenado en 3 bloques con 3 métricas cada uno -->
      <section class="summary-card mt-3">
        <div class="row g-3" id="summary">
          <!-- Bloque 1 -->
          <div class="col-12 col-md-4">
            <div class="d-flex flex-column gap-2">
              <div><span class="summary-chip">Total de pacientes:</span> <span id="total-patients">0</span></div>
              <div><span class="summary-chip">En urgencias:</span> <span id="u-patients">0</span></div>
              <div><span class="summary-chip">En planta:</span> <span id="p-patients">0</span></div>
            </div>
          </div>
          <!-- Bloque 2 -->
          <div class="col-12 col-md-4">
            <div class="d-flex flex-column gap-2">
              <div><span class="summary-chip">Dados de alta:</span> <span id="dados-alta">0</span></div>
              <div><span class="summary-chip">Ingresados:</span> <span id="ingresados-patients">0</span></div>
              <div><span class="summary-chip">Pendientes:</span> <span id="pending-patients">0</span></div>
            </div>
          </div>
          <!-- Bloque 3 -->
          <div class="col-12 col-md-4">
            <div class="d-flex flex-column gap-2">
              <div><span class="summary-chip">IQ totales:</span> <span id="total-iq">0</span></div>
              <div><span class="summary-chip">IQ generales:</span> <span id="iq-general">0</span></div>
              <div><span class="summary-chip">IQ locales:</span> <span id="iq-local">0</span></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal Paciente -->
  <div class="modal fade" id="patient-modal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="patientModalLabel">Añadir Paciente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="patient-form" novalidate>
            <input type="hidden" id="patient-id" />
            <div class="row">
              <div class="col-md-12 mb-3">
                <label for="nombre" class="form-label">Nombre y Apellidos</label>
                <input type="text" id="nombre" class="form-control" required />
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="diagnostico" class="form-label">Diagnóstico</label>
                <input type="text" id="diagnostico" class="form-control" required />
              </div>
              <div class="col-md-6 mb-3">
                <label for="tratamiento" class="form-label">Tratamiento</label>
                <select id="tratamiento" class="form-select" required>
                  <option value="Médico">Médico</option>
                  <option value="IQ Local">IQ Local</option>
                  <option value="IQ General">IQ General</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="localizacion" class="form-label">Localización</label>
                <select id="localizacion" class="form-select" required>
                  <option value="Urgencias">Urgencias</option>
                  <option value="Planta">Planta</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label for="sitio" class="form-label">Sitio (Cama/Box)</label>
                <input type="text" id="sitio" class="form-control" required />
              </div>
              <div class="col-md-4 mb-3">
                <label for="estado" class="form-label">Estado</label>
                <select id="estado" class="form-select" required>
                  <option value="Pendiente">Pendiente</option>
                  <option value="Ingresado">Ingresado</option>
                  <option value="Alta">Alta</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="comentario" class="form-label">Comentario</label>
              <textarea id="comentario" class="form-control" rows="3"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              <button type="submit" class="btn btn-primary">Guardar cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, writeBatch, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- CONFIG FIREBASE (mantener tal cual) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBHXJyws_bbbgn8qfkhSwtsqMI6KD8wT_c",
      authDomain: "estadillo-e5cdc.firebaseapp.com",
      projectId: "estadillo-e5cdc",
      storageBucket: "estadillo-e5cdc.appspot.com",
      messagingSenderId: "626738853027",
      appId: "1:626738853027:web:5379647c00479b47107b16"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginView = document.getElementById('login-view');
    const registerView = document.getElementById('register-view');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const logoutBtn = document.getElementById('logout-btn');

    const guardiaDateEl = document.getElementById('guardia-date');
    const changeGuardBtn = document.getElementById('change-guard-btn');
    const exportPdfBtn = document.getElementById('export-pdf-btn');

    const addPatientBtn = document.getElementById('add-patient-btn');
    const patientModalEl = document.getElementById('patient-modal');
    const patientModal = new bootstrap.Modal(patientModalEl);
    const patientModalLabel = document.getElementById('patientModalLabel');

    const filterTabButtons = document.querySelectorAll('.filter-tabs .nav-link');

    const patientForm = document.getElementById('patient-form');
    const patientTableBody = document.getElementById('patient-table-body');

    let currentGuardiaId = null;
    let pacientesCache = [];
    let currentFilter = 'todos';

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
      if (user && user.emailVerified) {
        authContainer.style.display = 'none';
        appContainer.style.display = 'block';
        loadGuardiaData();
      } else if (user && !user.emailVerified) {
        authContainer.style.display = 'block';
        appContainer.style.display = 'none';
        loginView.innerHTML = `
          <div class="alert alert-warning mb-3">Se ha enviado un correo de verificación a <strong>${user.email}</strong>. Por favor, revísalo.</div>
          <div class="d-flex gap-2">
            <button id="resend-verification" class="btn btn-secondary">Reenviar correo</button>
            <button id="force-logout" class="btn btn-danger">Cancelar</button>
          </div>`;
        document.getElementById('force-logout').addEventListener('click', () => signOut(auth));
        document.getElementById('resend-verification').addEventListener('click', () => sendEmailVerification(user).then(() => alert('Correo reenviado.')));
      } else {
        authContainer.style.display = 'block';
        appContainer.style.display = 'none';
      }
    });

    const togglePasswordVisibility = (inputId, toggleId) => {
      const input = document.getElementById(inputId);
      const btn = document.getElementById(toggleId);
      if (!input || !btn) return;
      const icon = btn.querySelector('i');
      if (!icon) return;
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
      } else {
        input.type = 'password';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
      }
    };
    document.getElementById('toggle-login-password').addEventListener('click', () => togglePasswordVisibility('login-password','toggle-login-password'));
    document.getElementById('toggle-register-password').addEventListener('click', () => togglePasswordVisibility('register-password','toggle-register-password'));

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      signInWithEmailAndPassword(auth, email, password).catch(err => {
        console.error('Login Error:', err);
        document.getElementById('login-error').textContent = 'Email o contraseña incorrectos.';
      });
    });

    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value;
      const errorDiv = document.getElementById('register-error');
      errorDiv.textContent = '';

      if (!email.endsWith('@ssib.es')) {
        errorDiv.textContent = 'El email debe ser del dominio @ssib.es.';
        return;
      }
      if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(password)) {
        errorDiv.textContent = 'La contraseña no cumple los requisitos.';
        return;
      }
      createUserWithEmailAndPassword(auth, email, password)
        .then(cred => sendEmailVerification(cred.user).then(() => { alert('¡Registro exitoso! Revisa tu email para verificar la cuenta.'); signOut(auth); }))
        .catch(err => { console.error('Register Error:', err); errorDiv.textContent = err.code === 'auth/email-already-in-use' ? 'Email ya registrado.' : 'Error en el registro.'; });
    });

    logoutBtn.addEventListener('click', () => signOut(auth).then(() => location.reload()));
    document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); loginView.style.display='none'; registerView.style.display='block'; });
    document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); registerView.style.display='none'; loginView.style.display='block'; });

    // --- APP CORE ---
    async function loadGuardiaData() {
      const stateRef = doc(db, 'app_state', 'current_guard');
      try {
        const stateSnap = await getDoc(stateRef);
        let guardiaStartDate;
        if (stateSnap.exists()) {
          const stateData = stateSnap.data();
          currentGuardiaId = stateData.activeGuardiaId;
          guardiaStartDate = stateData.startDate;
        } else {
          // primera vez
          const newGuardiaRef = doc(collection(db, 'guardias_activas'));
          currentGuardiaId = newGuardiaRef.id;
          guardiaStartDate = new Date().toISOString();
          await setDoc(stateRef, { activeGuardiaId: currentGuardiaId, startDate: guardiaStartDate });
        }
        const d = new Date(guardiaStartDate);
        guardiaDateEl.textContent = `Guardia del ${d.toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit', year:'numeric' })}`;
        await loadPatients();
      } catch (error) {
        console.error('Error crítico cargando estado:', error);
        alert('No se pudo cargar la información de la guardia. Revisa reglas de seguridad y la conexión.');
      }
    }

    async function loadPatients() {
      if (!currentGuardiaId) return;
      const qy = query(collection(db, 'guardias_activas', currentGuardiaId, 'pacientes'), orderBy('nombre'));
      try {
        const snapshot = await getDocs(qy);
        pacientesCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTable();
        updateSummary();
      } catch (error) {
        console.error('Error cargando pacientes:', error);
        alert('Error de permisos al cargar datos. Revisa las reglas de Firestore.');
      }
    }

    function setSelectColor(selectElement) {
      selectElement.classList.remove('bg-warning','text-dark','bg-primary','text-white','bg-success','bg-secondary');
      const v = selectElement.value;
      if (v === 'Pendiente') selectElement.classList.add('bg-warning','text-dark');
      else if (v === 'Ingresado') selectElement.classList.add('bg-primary','text-white');
      else if (v === 'Alta') selectElement.classList.add('bg-success','text-white');
      else selectElement.classList.add('bg-secondary','text-white');
    }

    function matchesFilter(p) {
      if (currentFilter === 'pendientes') return p.estado === 'Pendiente';
      if (currentFilter === 'resueltos') return p.estado !== 'Pendiente';
      return true; // todos
    }

    function renderTable() {
      patientTableBody.innerHTML = '';
      const visibles = pacientesCache.filter(p => matchesFilter(p));

      visibles.forEach(paciente => {
        const row = document.createElement('tr');
        row.dataset.id = paciente.id || '';
        if (paciente.estado === 'Pendiente') row.classList.add('patient-pending');

        const tdText = (text) => { const td = document.createElement('td'); td.textContent = text ?? ''; return td; };

        row.appendChild(tdText(paciente.localizacion));
        row.appendChild(tdText(paciente.sitio));
        row.appendChild(tdText(paciente.nombre));
        row.appendChild(tdText(paciente.diagnostico));

        // Tratamiento
        const tdTrat = document.createElement('td');
        const selTrat = document.createElement('select');
        selTrat.className = 'form-select form-select-sm inline-select';
        ['Médico','IQ Local','IQ General'].forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; if (opt === paciente.tratamiento) o.selected = true; selTrat.appendChild(o); });
        selTrat.addEventListener('change', (e) => handleInlineUpdate(paciente.id, 'tratamiento', e.target.value));
        tdTrat.appendChild(selTrat);
        row.appendChild(tdTrat);

        row.appendChild(tdText(paciente.comentario));

        // Estado
        const tdEstado = document.createElement('td');
        const selEstado = document.createElement('select');
        selEstado.className = 'form-select form-select-sm inline-select';
        ['Pendiente','Ingresado','Alta'].forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; if (opt === paciente.estado) o.selected = true; selEstado.appendChild(o); });
        setSelectColor(selEstado);
        selEstado.addEventListener('change', (e) => {
          handleInlineUpdate(paciente.id, 'estado', e.target.value);
          setSelectColor(e.target);
          if (e.target.value === 'Pendiente') row.classList.add('patient-pending'); else row.classList.remove('patient-pending');
        });
        tdEstado.appendChild(selEstado);
        row.appendChild(tdEstado);

        // Acciones
        const tdActions = document.createElement('td');
        tdActions.className = 'table-actions text-nowrap';
        const editBtn = document.createElement('button'); editBtn.className = 'btn btn-sm btn-outline-primary'; editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.addEventListener('click', () => handleEdit(paciente.id));
        const delBtn = document.createElement('button'); delBtn.className = 'btn btn-sm btn-outline-danger'; delBtn.innerHTML = '<i class="bi bi-trash"></i>';
        delBtn.addEventListener('click', () => handleDelete(paciente.id));
        tdActions.appendChild(editBtn); tdActions.appendChild(delBtn);
        row.appendChild(tdActions);

        patientTableBody.appendChild(row);
      });
    }

    async function handleInlineUpdate(id, field, value) {
      const patientRef = doc(db, 'guardias_activas', currentGuardiaId, 'pacientes', id);
      try {
        await updateDoc(patientRef, { [field]: value, updatedAt: serverTimestamp() });
        const idx = pacientesCache.findIndex(p => p.id === id);
        if (idx > -1) { pacientesCache[idx][field] = value; updateSummary(); }
      } catch (error) {
        console.error('Error en actualización rápida:', error);
        alert('No se pudo guardar el cambio.');
      }
    }

    addPatientBtn.addEventListener('click', () => {
      patientForm.reset();
      document.getElementById('patient-id').value = '';
      patientModalLabel.textContent = 'Añadir Paciente';
      patientModal.show();
    });

    function handleEdit(id) {
      const p = pacientesCache.find(x => x.id === id);
      if (!p) return;
      patientForm.reset();
      document.getElementById('patient-id').value = p.id;
      document.getElementById('nombre').value = p.nombre ?? '';
      document.getElementById('diagnostico').value = p.diagnostico ?? '';
      document.getElementById('tratamiento').value = p.tratamiento ?? 'Médico';
      document.getElementById('localizacion').value = p.localizacion ?? 'Urgencias';
      document.getElementById('sitio').value = p.sitio ?? '';
      document.getElementById('estado').value = p.estado ?? 'Pendiente';
      document.getElementById('comentario').value = p.comentario ?? '';
      patientModalLabel.textContent = 'Editar Paciente';
      patientModal.show();
    }

    patientForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('patient-id').value;
      const data = {
        localizacion: document.getElementById('localizacion').value,
        sitio: document.getElementById('sitio').value.trim(),
        nombre: document.getElementById('nombre').value.trim(),
        diagnostico: document.getElementById('diagnostico').value.trim(),
        tratamiento: document.getElementById('tratamiento').value,
        comentario: document.getElementById('comentario').value.trim(),
        estado: document.getElementById('estado').value,
        updatedAt: serverTimestamp()
      };
      try {
        if (id) {
          await updateDoc(doc(db, 'guardias_activas', currentGuardiaId, 'pacientes', id), data);
        } else {
          await addDoc(collection(db, 'guardias_activas', currentGuardiaId, 'pacientes'), { ...data, createdAt: serverTimestamp() });
        }
        patientModal.hide();
        await loadPatients();
      } catch (error) {
        console.error('Error guardando paciente:', error);
        alert('Error al guardar el paciente. Revisa la consola.');
      }
    });

    async function handleDelete(id) {
      if (!confirm('¿Borrar este registro?')) return;
      try {
        await deleteDoc(doc(db, 'guardias_activas', currentGuardiaId, 'pacientes', id));
        await loadPatients();
      } catch (error) { console.error('Error borrando paciente:', error); }
    }

    function updateSummary() {
      const total = pacientesCache.length;
      const urg = pacientesCache.filter(p => p.localizacion === 'Urgencias').length;
      const pla = pacientesCache.filter(p => p.localizacion === 'Planta').length;

      const dadosAlta = pacientesCache.filter(p => p.estado === 'Alta').length;
      const ingresados = pacientesCache.filter(p => p.estado === 'Ingresado').length;
      const pendientes = pacientesCache.filter(p => p.estado === 'Pendiente').length;

      const iqLocal = pacientesCache.filter(p => p.tratamiento === 'IQ Local').length;
      const iqGeneral = pacientesCache.filter(p => p.tratamiento === 'IQ General').length;

      document.getElementById('total-patients').textContent = total;
      document.getElementById('u-patients').textContent = urg;
      document.getElementById('p-patients').textContent = pla;

      document.getElementById('dados-alta').textContent = dadosAlta;
      document.getElementById('ingresados-patients').textContent = ingresados;
      document.getElementById('pending-patients').textContent = pendientes;

      document.getElementById('total-iq').textContent = iqLocal + iqGeneral;
      document.getElementById('iq-general').textContent = iqGeneral;
      document.getElementById('iq-local').textContent = iqLocal;
    }

    // Filtros
    filterTabButtons.forEach(btn => btn.addEventListener('click', (e) => {
      filterTabButtons.forEach(b => b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      currentFilter = e.currentTarget.getAttribute('data-filter');
      renderTable();
    }));

    // Exportar a PDF (vista de impresión)
    exportPdfBtn.addEventListener('click', () => window.print());

    // Cambiar guardia
    changeGuardBtn.addEventListener('click', async () => {
      if (!confirm('¿Finalizar la guardia actual? Se archivarán los datos y los pacientes pendientes pasarán a la siguiente.')) return;
      try {
        const stateRef = doc(db, 'app_state', 'current_guard');
        const fechaArchivo = new Date().toISOString().split('T')[0];
        const archivoRef = doc(db, 'guardias_archivadas', `${fechaArchivo}_${currentGuardiaId}`);

        const batch = writeBatch(db);
        batch.set(archivoRef, { fecha: new Date().toISOString(), pacientes: pacientesCache });
        pacientesCache.forEach(p => batch.delete(doc(db, 'guardias_activas', currentGuardiaId, 'pacientes', p.id)));

        const newGuardiaRef = doc(collection(db, 'guardias_activas'));
        const newGuardiaId = newGuardiaRef.id;
        const pendientes = pacientesCache.filter(p => p.estado === 'Pendiente');
        pendientes.forEach(p => { const { id, ...data } = p; const newRef = doc(collection(db, 'guardias_activas', newGuardiaId, 'pacientes')); batch.set(newRef, data); });

        await batch.commit();
        await setDoc(stateRef, { activeGuardiaId: newGuardiaId, startDate: new Date().toISOString() });
        alert('Guardia finalizada y archivada. Nueva guardia iniciada.');
        location.reload();
      } catch (error) {
        console.error('Error al cambiar de guardia:', error);
        alert('Error cambiando la guardia. Revisa la consola.');
      }
    });
  </script>
</body>
</html>