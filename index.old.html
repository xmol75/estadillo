<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadillo de Guardia - Cirugía</title>
    
    <!-- Bootstrap CSS y Icons para un diseño limpio y responsivo -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Estilos generales y para la interfaz */
        body {
            background-color: #f8f9fa;
        }
        #app-container {
            display: none; /* La app principal está oculta hasta que el usuario inicie sesión */
        }
        .password-container {
            position: relative;
        }
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%; /* centrado vertical consistente */
            transform: translateY(-50%);
            cursor: pointer;
            color: #6c757d;
            font-size: 1.25rem; /* Icono más grande */
        }
        .form-section, .table-section {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        .summary-card {
            background-color: #e9ecef;
        }
        #password-rules ul {
            padding-left: 20px;
            font-size: 0.875rem;
            color: #6c757d;
        }
        .table-actions .btn {
            margin-right: 5px;
        }
        .inline-select {
            min-width: 120px;
            font-weight: 500;
        }
        /* Estilo para resaltar las filas de pacientes pendientes */
        .patient-pending {
            background-color: #fff3cd !important;
        }
    </style>
</head>
<body>

    <div class="container mt-4">
        <!-- SECCIÓN DE AUTENTICACIÓN: LOGIN Y REGISTRO -->
        <div id="auth-container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="text-center mb-4">
                        <h2>Estadillo de Guardia de Cirugía</h2>
                        <p class="text-muted">Hospital Universitari Son Espases</p>
                    </div>

                    <!-- Formulario de Login -->
                    <div id="login-view">
                        <div class="form-section">
                            <h3 class="mb-4">Iniciar Sesión</h3>
                            <form id="login-form" novalidate>
                                <div class="mb-3">
                                    <label for="login-email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="login-email" required>
                                </div>
                                <div class="mb-3 password-container">
                                    <label for="login-password" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="login-password" required>
                                    <i class="bi bi-eye-slash password-toggle" id="toggle-login-password"></i>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Entrar</button>
                                <div id="login-error" class="text-danger mt-2"></div>
                            </form>
                            <p class="mt-3 text-center">¿No tienes cuenta? <a href="#" id="show-register">Regístrate aquí</a></p>
                        </div>
                    </div>

                    <!-- Formulario de Registro -->
                    <div id="register-view" style="display: none;">
                        <div class="form-section">
                            <h3 class="mb-4">Registro</h3>
                            <form id="register-form" novalidate>
                                <div class="mb-3">
                                    <label for="register-email" class="form-label">Email Corporativo (@ssib.es)</label>
                                    <input type="email" class="form-control" id="register-email" required>
                                </div>
                                <div class="mb-3 password-container">
                                    <label for="register-password" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="register-password" required>
                                     <i class="bi bi-eye-slash password-toggle" id="toggle-register-password"></i>
                                </div>
                                <div id="password-rules" class="form-text mb-3">
                                   <ul>
                                       <li>Al menos 8 caracteres</li>
                                       <li>Una mayúscula (ej: A, B, C)</li>
                                       <li>Un número (ej: 1, 2, 3)</li>
                                       <li>Un símbolo especial (ej: @, $, !)</li>
                                   </ul>
                                </div>
                                <button type="submit" class="btn btn-success w-100">Registrarse</button>
                                <div id="register-error" class="text-danger mt-2"></div>
                            </form>
                            <p class="mt-3 text-center">¿Ya tienes cuenta? <a href="#" id="show-login">Inicia sesión</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- APLICACIÓN PRINCIPAL (Visible tras login) -->
        <div id="app-container">
            <header class="text-center py-3">
                <h1 class="h4">Estadillo de guardia del Servicio de Cirugía General y del Aparato Digestivo</h1>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <h4 id="guardia-date" class="mb-0"></h4>
                    <div>
                         <button id="change-guard-btn" class="btn btn-warning me-2">Finalizar y Cambiar Guardia</button>
                         <button id="logout-btn" class="btn btn-danger">Cerrar Sesión</button>
                    </div>
                </div>
            </header>
            
            <hr>

            <!-- Lista de Pacientes -->
            <section class="table-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Pacientes de la Guardia</h3>
                    <div>
                        <button id="add-patient-btn" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Añadir Paciente</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="patient-table" class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Localización</th>
                                <th>Sitio</th>
                                <th>Nombre y Apellidos</th>
                                <th>Diagnóstico</th>
                                <th>Tratamiento</th>
                                <th>Comentario</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="patient-table-body">
                           <!-- Los datos de los pacientes se insertarán aquí dinámicamente desde Firebase -->
                        </tbody>
                    </table>
                </div>
            </section>

            <hr>

            <!-- Resumen y Estadísticas de la guardia -->
            <section class="summary-card p-4 rounded">
                <div class="d-flex justify-content-between align-items-center">
                    <h3>Resumen de la Guardia</h3>
                </div>
                <div id="summary" class="row mt-3">
                    <div class="col-md-3"><strong>Total Pacientes:</strong> <span id="total-patients">0</span></div>
                    <div class="col-md-3"><strong>Pendientes:</strong> <span id="pending-patients">0</span></div>
                    <div class="col-md-3"><strong>Resueltos:</strong> <span id="resolved-patients">0</span></div>
                    <div class="col-md-3"><strong>IQ Totales:</strong> <span id="total-iq">0</span></div>
                </div>
            </section>
        </div>
    </div>

    <!-- Modal para Añadir/Editar Paciente -->
    <div class="modal fade" id="patient-modal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientModalLabel">Añadir Paciente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="patient-form" novalidate>
                        <input type="hidden" id="patient-id">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="nombre" class="form-label">Nombre y Apellidos</label>
                                <input type="text" id="nombre" class="form-control" required>
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-6 mb-3">
                                <label for="diagnostico" class="form-label">Diagnóstico</label>
                                <input type="text" id="diagnostico" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="tratamiento" class="form-label">Tratamiento</label>
                                <select id="tratamiento" class="form-select" required>
                                    <option value="Médico">Médico</option>
                                    <option value="IQ Local">IQ Local</option>
                                    <option value="IQ General">IQ General</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="localizacion" class="form-label">Localización</label>
                                <select id="localizacion" class="form-select" required>
                                    <option value="Urgencias">Urgencias</option>
                                    <option value="Planta">Planta</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="sitio" class="form-label">Sitio (Cama/Box)</label>
                                <input type="text" id="sitio" class="form-control" required>
                            </div>
                             <div class="col-md-4 mb-3">
                                <label for="estado" class="form-label">Estado</label>
                                <select id="estado" class="form-select" required>
                                    <option value="Pendiente">Pendiente</option>
                                    <option value="Ingresado">Ingresado</option>
                                    <option value="Alta">Alta</option>
                                </select>
                            </div>
                        </div>
                         <div class="mb-3">
                            <label for="comentario" class="form-label">Comentario</label>
                            <textarea id="comentario" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SDKs de Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        sendEmailVerification,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import { 
        getFirestore, 
        collection, 
        addDoc, 
        getDocs,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        writeBatch,
        query,
        orderBy,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // Configuración de Firebase.
      const firebaseConfig = {
        apiKey: "AIzaSyBHXJyws_bbbgn8qfkhSwtsqMI6KD8wT_c",
        authDomain: "estadillo-e5cdc.firebaseapp.com",
        projectId: "estadillo-e5cdc",
        storageBucket: "estadillo-e5cdc.appspot.com",
        messagingSenderId: "626738853027",
        appId: "1:626738853027:web:5379647c00479b47107b16"
      };

      // Inicializar Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      // --- REFERENCIAS A ELEMENTOS DEL DOM ---
      const authContainer = document.getElementById('auth-container');
      const appContainer = document.getElementById('app-container');
      const loginView = document.getElementById('login-view');
      const registerView = document.getElementById('register-view');
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      const logoutBtn = document.getElementById('logout-btn');
      const patientForm = document.getElementById('patient-form');
      const patientTableBody = document.getElementById('patient-table-body');
      const guardiaDateEl = document.getElementById('guardia-date');
      const changeGuardBtn = document.getElementById('change-guard-btn');
      const addPatientBtn = document.getElementById('add-patient-btn');
      
      const patientModalEl = document.getElementById('patient-modal');
      const patientModal = new bootstrap.Modal(patientModalEl);
      const patientModalLabel = document.getElementById('patientModalLabel');

      let currentGuardiaId = null;
      let pacientesCache = []; // Caché local de pacientes
      
      // --- LÓGICA DE AUTENTICACIÓN ---
      onAuthStateChanged(auth, (user) => {
          if (user && user.emailVerified) {
              authContainer.style.display = 'none';
              appContainer.style.display = 'block';
              loadGuardiaData();
          } else if (user && !user.emailVerified) {
              authContainer.style.display = 'block';
              appContainer.style.display = 'none';
              loginView.innerHTML = `
                  <div class="alert alert-warning">
                      Se ha enviado un correo de verificación a <strong>${user.email}</strong>. Por favor, revísalo.
                  </div>
                  <button id="resend-verification" class="btn btn-secondary mb-2">Reenviar correo</button>
                  <button id="force-logout" class="btn btn-danger">Cancelar</button>
              `;
              document.getElementById('force-logout').addEventListener('click', () => signOut(auth));
              document.getElementById('resend-verification').addEventListener('click', () => sendEmailVerification(user).then(() => alert('Correo reenviado.')));
          } else {
              authContainer.style.display = 'block';
              appContainer.style.display = 'none';
          }
      });
      
      const togglePasswordVisibility = (inputId, toggleId) => {
          const passwordInput = document.getElementById(inputId);
          const toggleIcon = document.getElementById(toggleId);
          passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
          toggleIcon.classList.toggle('bi-eye-slash');
          toggleIcon.classList.toggle('bi-eye');
      };
      document.getElementById('toggle-login-password').addEventListener('click', () => togglePasswordVisibility('login-password', 'toggle-login-password'));
      document.getElementById('toggle-register-password').addEventListener('click', () => togglePasswordVisibility('register-password', 'toggle-register-password'));

      loginForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const email = document.getElementById('login-email').value.trim();
          const password = document.getElementById('login-password').value;
          signInWithEmailAndPassword(auth, email, password)
              .catch(err => {
                console.error("Login Error:", err);
                document.getElementById('login-error').textContent = 'Email o contraseña incorrectos.';
              });
      });
      
      registerForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const email = document.getElementById('register-email').value.trim();
          const password = document.getElementById('register-password').value;
          const errorDiv = document.getElementById('register-error');
          errorDiv.textContent = ''; // Limpiar errores previos

          if (!email.endsWith('@ssib.es')) {
              errorDiv.textContent = 'El email debe ser del dominio @ssib.es.';
              return;
          }
          if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,}$/.test(password)) {
              errorDiv.textContent = 'La contraseña no cumple los requisitos.';
              return;
          }
          createUserWithEmailAndPassword(auth, email, password)
              .then(cred => sendEmailVerification(cred.user).then(() => {
                  alert("¡Registro exitoso! Revisa tu email para verificar la cuenta.");
                  signOut(auth);
              }))
              .catch(err => {
                console.error("Register Error:", err);
                errorDiv.textContent = err.code === 'auth/email-already-in-use' ? 'Email ya registrado.' : 'Error en el registro.';
              });
      });

      logoutBtn.addEventListener('click', () => signOut(auth).then(() => location.reload()));
      document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); loginView.style.display = 'none'; registerView.style.display = 'block'; });
      document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); registerView.style.display = 'none'; loginView.style.display = 'block'; });
      
      // --- LÓGICA DE LA APLICACIÓN ---
      
      async function loadGuardiaData() {
          const stateRef = doc(db, 'app_state', 'current_guard');
          try {
              const stateSnap = await getDoc(stateRef);
              let guardiaStartDate;
              if (stateSnap.exists()) {
                  const stateData = stateSnap.data();
                  currentGuardiaId = stateData.activeGuardiaId;
                  guardiaStartDate = stateData.startDate;
              } else {
                  // Si no hay estado, es la primera vez que se ejecuta la app
                  const newGuardiaRef = doc(collection(db, 'guardias_activas'));
                  currentGuardiaId = newGuardiaRef.id;
                  guardiaStartDate = new Date().toISOString();
                  await setDoc(stateRef, { activeGuardiaId: currentGuardiaId, startDate: guardiaStartDate });
              }
              const date = new Date(guardiaStartDate);
              guardiaDateEl.textContent = `Guardia del: ${date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
              loadPatients();
          } catch (error) {
              console.error("Error crítico cargando estado de la guardia:", error);
              alert("No se pudo cargar la información de la guardia. Revisa las reglas de seguridad y la conexión.");
          }
      }

      async function loadPatients() {
        if (!currentGuardiaId) return;
        const q = query(collection(db, 'guardias_activas', currentGuardiaId, 'pacientes'), orderBy("nombre"));
        try {
            const snapshot = await getDocs(q);
            pacientesCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            patientTableBody.innerHTML = '';
            pacientesCache.forEach(renderPatient);
            updateSummary();
        } catch(error) { 
            console.error("Error cargando pacientes: ", error); 
            alert("Error de permisos al cargar los datos. Asegúrate de que las reglas de seguridad de Firestore están configuradas correctamente.");
        }
      }

      function setSelectColor(selectElement) {
        selectElement.classList.remove('bg-warning', 'text-dark', 'bg-primary', 'text-white', 'bg-success', 'bg-secondary');
        const value = selectElement.value;
        if (value === 'Pendiente') {
            selectElement.classList.add('bg-warning', 'text-dark');
        } else if (value === 'Ingresado') {
            selectElement.classList.add('bg-primary', 'text-white');
        } else if (value === 'Alta') {
            selectElement.classList.add('bg-success', 'text-white');
        } else {
            selectElement.classList.add('bg-secondary', 'text-white');
        }
      }

      function renderPatient(paciente) {
        const row = document.createElement('tr');
        row.dataset.id = paciente.id || '';

        // Resaltado si está pendiente
        if (paciente.estado === 'Pendiente') {
            row.classList.add('patient-pending');
        }

        // Helper para crear TD con textContent seguro
        const tdText = (text) => {
            const td = document.createElement('td');
            td.textContent = text ?? '';
            return td;
        };

        // Localización
        row.appendChild(tdText(paciente.localizacion));
        // Sitio
        row.appendChild(tdText(paciente.sitio));
        // Nombre
        row.appendChild(tdText(paciente.nombre));
        // Diagnóstico
        row.appendChild(tdText(paciente.diagnostico));

        // Tratamiento (select)
        const tdTrat = document.createElement('td');
        const selTrat = document.createElement('select');
        selTrat.className = 'form-select form-select-sm inline-select';
        ['Médico','IQ Local','IQ General'].forEach(opt => {
            const o = document.createElement('option');
            o.value = opt; o.textContent = opt;
            if (opt === paciente.tratamiento) o.selected = true;
            selTrat.appendChild(o);
        });
        selTrat.addEventListener('change', (e) => {
            handleInlineUpdate(paciente.id, 'tratamiento', e.target.value);
        });
        tdTrat.appendChild(selTrat);
        row.appendChild(tdTrat);

        // Comentario
        row.appendChild(tdText(paciente.comentario));

        // Estado (select con color)
        const tdEstado = document.createElement('td');
        const selEstado = document.createElement('select');
        selEstado.className = 'form-select form-select-sm inline-select';
        ['Pendiente','Ingresado','Alta'].forEach(opt => {
            const o = document.createElement('option');
            o.value = opt; o.textContent = opt;
            if (opt === paciente.estado) o.selected = true;
            selEstado.appendChild(o);
        });
        setSelectColor(selEstado);
        selEstado.addEventListener('change', (e) => {
            handleInlineUpdate(paciente.id, 'estado', e.target.value);
            setSelectColor(e.target);
            if (e.target.value === 'Pendiente') {
                row.classList.add('patient-pending');
            } else {
                row.classList.remove('patient-pending');
            }
        });
        tdEstado.appendChild(selEstado);
        row.appendChild(tdEstado);

        // Acciones
        const tdActions = document.createElement('td');
        tdActions.className = 'table-actions';
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-outline-primary edit-btn';
        editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
        editBtn.addEventListener('click', () => handleEdit(paciente.id));
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-outline-danger delete-btn';
        delBtn.innerHTML = '<i class="bi bi-trash"></i>';
        delBtn.addEventListener('click', () => handleDelete(paciente.id));
        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);
        row.appendChild(tdActions);

        patientTableBody.appendChild(row);
      }
      
      async function handleInlineUpdate(id, field, value) {
        const patientRef = doc(db, 'guardias_activas', currentGuardiaId, 'pacientes', id);
        try {
            await updateDoc(patientRef, { [field]: value, updatedAt: serverTimestamp() });
            const patientIndex = pacientesCache.findIndex(p => p.id === id);
            if (patientIndex > -1) {
                pacientesCache[patientIndex][field] = value;
                updateSummary();
            }
        } catch (error) {
            console.error("Error en actualización rápida: ", error);
            alert('No se pudo guardar el cambio.');
        }
      }

      addPatientBtn.addEventListener('click', () => {
          patientForm.reset();
          document.getElementById('patient-id').value = '';
          patientModalLabel.textContent = 'Añadir Paciente';
          patientModal.show();
      });

      function handleEdit(id) {
        const paciente = pacientesCache.find(p => p.id === id);
        if (paciente) {
            patientForm.reset();
            document.getElementById('patient-id').value = paciente.id;
            document.getElementById('nombre').value = paciente.nombre ?? '';
            document.getElementById('diagnostico').value = paciente.diagnostico ?? '';
            document.getElementById('tratamiento').value = paciente.tratamiento ?? 'Médico';
            document.getElementById('localizacion').value = paciente.localizacion ?? 'Urgencias';
            document.getElementById('sitio').value = paciente.sitio ?? '';
            document.getElementById('estado').value = paciente.estado ?? 'Pendiente';
            document.getElementById('comentario').value = paciente.comentario ?? '';
            
            patientModalLabel.textContent = 'Editar Paciente';
            patientModal.show();
        }
      }

      patientForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('patient-id').value;
        const pacienteData = {
            localizacion: document.getElementById('localizacion').value,
            sitio: document.getElementById('sitio').value.trim(),
            nombre: document.getElementById('nombre').value.trim(),
            diagnostico: document.getElementById('diagnostico').value.trim(),
            tratamiento: document.getElementById('tratamiento').value,
            comentario: document.getElementById('comentario').value.trim(),
            estado: document.getElementById('estado').value,
            updatedAt: serverTimestamp()
        };

        try {
            if (id) {
                await updateDoc(doc(db, 'guardias_activas', currentGuardiaId, 'pacientes', id), pacienteData);
            } else {
                await addDoc(collection(db, 'guardias_activas', currentGuardiaId, 'pacientes'), {
                    ...pacienteData,
                    createdAt: serverTimestamp()
                });
            }
            patientModal.hide();
            loadPatients();
        } catch (error) { 
            console.error("Error guardando paciente: ", error);
            alert("Error al guardar el paciente. Revise la consola para más detalles.");
        }
      });

      async function handleDelete(id) {
        if (confirm('¿Estás seguro de que quieres borrar este registro?')) {
            try {
                await deleteDoc(doc(db, 'guardias_activas', currentGuardiaId, 'pacientes', id));
                loadPatients();
            } catch (error) { console.error("Error borrando paciente: ", error); }
        }
      }

      function updateSummary() {
        if (!pacientesCache) return;
        const total = pacientesCache.length;
        const pendientes = pacientesCache.filter(p => p.estado === 'Pendiente').length;
        const resueltos = total - pendientes;
        const iqLocal = pacientesCache.filter(p => p.tratamiento === 'IQ Local').length;
        const iqGeneral = pacientesCache.filter(p => p.tratamiento === 'IQ General').length;
        
        document.getElementById('total-patients').textContent = total;
        document.getElementById('pending-patients').textContent = pendientes;
        document.getElementById('resolved-patients').textContent = resueltos;
        document.getElementById('total-iq').textContent = iqLocal + iqGeneral;
      }
      
      if(document.getElementById('refresh-summary-btn')) {
          document.getElementById('refresh-summary-btn').addEventListener('click', loadPatients);
      }


      changeGuardBtn.addEventListener('click', async () => {
          if (!confirm('¿Finalizar la guardia actual? Se archivarán los datos y los pacientes pendientes pasarán a la siguiente.')) return;
          try {
            const stateRef = doc(db, 'app_state', 'current_guard');
            const fechaArchivo = new Date().toISOString().split('T')[0];
            const archivoRef = doc(db, 'guardias_archivadas', `${fechaArchivo}_${currentGuardiaId}`);
            
            const batch = writeBatch(db);
            batch.set(archivoRef, { fecha: new Date().toISOString(), pacientes: pacientesCache });
            
            pacientesCache.forEach(p => batch.delete(doc(db, 'guardias_activas', currentGuardiaId, 'pacientes', p.id)));

            const newGuardiaRef = doc(collection(db, 'guardias_activas'));
            const newGuardiaId = newGuardiaRef.id;
            
            const pacientesPendientes = pacientesCache.filter(p => p.estado === 'Pendiente');
            pacientesPendientes.forEach(p => {
                const { id, ...data } = p;
                const newPatientRef = doc(collection(db, 'guardias_activas', newGuardiaId, 'pacientes'));
                batch.set(newPatientRef, data);
            });
            
            await batch.commit();

            // Actualizar el estado central con la nueva guardia
            await setDoc(stateRef, { activeGuardiaId: newGuardiaId, startDate: new Date().toISOString() });
            
            alert('Guardia finalizada y archivada. Nueva guardia iniciada.');
            location.reload();
          } catch (error) { console.error("Error al cambiar de guardia: ", error); }
      });
      
    </script>
    
</body>
</html>
